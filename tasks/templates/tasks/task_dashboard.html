{% extends "base.html" %}
{% load static %}

{% block title %}–ó–∞–¥–∞—á—ñ{% endblock %}

{% block content %}
<div class="tasks-container">
  <h2 class="tasks-title">–ú–æ—ó –∑–∞–¥–∞—á—ñ</h2>

  <div class="tasks-controls">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

<style>
  .fc .fc-event,
  .fc .fc-event-title,
  .fc .fc-event-time,
  .fc .fc-event-main {
    color: #000 !important;
  }
  .fc-event-main-frame {
    color: #000 !important;
  }
</style>

    <div class="create-wrapper">
      {% if user.role == 'admin' or user.role == 'manager' %}
        <a href="{% url 'create_task' %}" class="create-btn">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–¥–∞—á—É</a>
      {% endif %}
    </div>

    <div class="view-switch">
      <button class="switch-btn active" data-tab="inbox">–í—Ö—ñ–¥–Ω—ñ</button>
      {% if user.role == 'admin' or user.role == 'manager' %}
        <button class="switch-btn" data-tab="sent">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ</button>
      {% endif %}
      <button class="switch-btn" data-tab="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</button>
    </div>
  </div>

  <!-- –í—Ö—ñ–¥–Ω—ñ -->
  <div id="inbox" class="task-list-tab active">
    {% if inbox_tasks %}
      <ul class="task-list">
        {% for task in inbox_tasks %}
          <li class="task-item task-{{ task.status }}" data-task-id="{{ task.id }}">
            <div class="task-header">
              <strong>{{ task.title }}</strong>
              <span class="task-dates">{{ task.start_date }} ‚Äì {{ task.end_date }}</span>
            </div>
            <div class="task-body">
              <p>{{ task.description }}</p>
              <small>
                <strong>–ê–≤—Ç–æ—Ä:</strong> {{ task.creator.full_name }} |
                <strong>Email:</strong> {{ task.creator.email }}<br>
                <strong>–í—ñ–¥–¥—ñ–ª –∞–≤—Ç–æ—Ä–∞:</strong> {{ task.creator.department.name }} |
                <strong>–ü–æ—Å–∞–¥–∞ –∞–≤—Ç–æ—Ä–∞:</strong> {{ task.creator.position }}<br>
                <strong>–ö–æ–º—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ:</strong>
                {% if task.assigned_user %}
                  {{ task.assigned_user.full_name }} ({{ task.assigned_user.email }})
                {% elif task.assigned_department %}
                  –í—ñ–¥–¥—ñ–ª ¬´{{ task.assigned_department.name }}¬ª
                {% endif %}<br>
                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                {% if task.status == 'new' %}
                  <span style="color:#3399ff;">–ù–µ –ø—Ä–∏–π–Ω—è—Ç–æ</span>
                {% elif task.status == 'in_progress' %}
                  <span style="color:#cc9900;">–£ —Ä–æ–±–æ—Ç—ñ</span>
                {% elif task.status == 'overdue' %}
                  <span style="color:#cc0000;">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ</span>
                {% elif task.status == 'completed' %}
                  <span style="color:#228B22;">–í–∏–∫–æ–Ω–∞–Ω–æ</span>
                {% endif %}
              </small>
            </div>

            {% if task.assigned_user == user %}
              <div class="task-actions">
                {% if task.status == 'new' %}
                  <form method="post" action="{% url 'take_task' task.id %}">
                    {% csrf_token %}
                    <button type="submit" class="icon-btn" style="outline: none; border: none; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);">‚úÖ –í–∑—è—Ç–∏ –≤ —Ä–æ–±–æ—Ç—É</button>
                  </form>
                {% elif task.status == 'in_progress' %}
                  <form method="post" action="{% url 'complete_task' task.id %}">
                    {% csrf_token %}
                    <button type="submit" class="icon-btn" style="outline: none; border: none; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
                  </form>
                {% endif %}
              </div>
            {% elif task.assigned_department == user.department and user.role == 'manager' %}
              <div class="task-actions">
                {% if task.status == 'new' %}
                  <form method="post" action="{% url 'take_task' task.id %}">
                    {% csrf_token %}
                    <button type="submit" class="icon-btn" style="outline: none; border: none; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);">‚úÖ –í–∑—è—Ç–∏ –≤ —Ä–æ–±–æ—Ç—É</button>
                  </form>
                {% elif task.status == 'in_progress' %}
                  <form method="post" action="{% url 'complete_task' task.id %}">
                    {% csrf_token %}
                    <button type="submit" class="icon-btn" style="outline: none; border: none; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
                  </form>
                {% endif %}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-tasks">–ù–µ–º–∞—î –≤—Ö—ñ–¥–Ω–∏—Ö –∑–∞–¥–∞—á.</p>
    {% endif %}
  </div>

  <div id="sent" class="task-list-tab">
    {% if sent_tasks %}
      <ul class="task-list">
        {% for task in sent_tasks %}
          <li class="task-item task-{{ task.status }}">
            <div class="task-header">
              <strong>{{ task.title }}</strong>
              <span class="task-dates">{{ task.start_date }} ‚Äì {{ task.end_date }}</span>
            </div>
            <div class="task-body">
              <p>{{ task.description }}</p>
              <small>
                <strong>–î–∞—Ç–∞:</strong> {{ task.start_date }} |
                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                {% if task.status == 'new' %}
                  <span style="color:#3399ff;">–ù–µ –ø—Ä–∏–π–Ω—è—Ç–æ</span>
                {% elif task.status == 'in_progress' %}
                  <span style="color:#cc9900;">–£ —Ä–æ–±–æ—Ç—ñ</span>
                {% elif task.status == 'overdue' %}
                  <span style="color:#cc0000;">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ</span>
                {% elif task.status == 'completed' %}
                  <span style="color:#228B22;">–í–∏–∫–æ–Ω–∞–Ω–æ</span>
                {% endif %}

                {% if task.assigned_user %}
                  | <strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong> {{ task.assigned_user.full_name }} ({{ task.assigned_user.email }})
                {% elif task.assigned_department %}
                  | <strong>–í—ñ–¥–¥—ñ–ª:</strong> {{ task.assigned_department.name }}
                {% endif %}
              </small>
            </div>
            <div class="task-actions">
              <a href="{% url 'update_task' task.id %}" class="icon-btn">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
              <a href="{% url 'delete_task' task.id %}" class="icon-btn">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</a>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-tasks">–ù–µ–º–∞—î –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –∑–∞–¥–∞—á.</p>
    {% endif %}
  </div>

<div id="calendar" class="task-list-tab">
  {% if user.role == 'admin' or user.role == 'manager' %}
    <div class="calendar-toggle" style="margin-bottom: 10px;">
      <label style="font-weight: bold;">
        <input type="checkbox" id="sent-tasks-toggle" style="margin-right: 6px;">
        –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –∑–∞–¥–∞—á—ñ
      </label>
    </div>
  {% endif %}
  <div id="calendar-widget"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.switch-btn');
    const tabs = document.querySelectorAll('.task-list-tab');
    const showSentCheckbox = document.getElementById('sent-tasks-toggle');
    let calendar;

    function showTab(name) {
      tabs.forEach(tab => tab.classList.toggle('active', tab.id === name));
      buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === name));

      if (name === 'calendar') {
        if (!window.calendarInitialized) {
          const calendarEl = document.getElementById('calendar-widget');
          calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'uk',
            firstDay: 1,
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            eventDisplay: 'block',
            events: getCalendarUrl(),
            eventClick: function(info) {
              alert(info.event.title + "\n\n" + info.event.extendedProps.description);
            },
            eventDidMount: function(info) {
              info.el.style.color = '#000';
              info.el.style.whiteSpace = 'normal';
            },
            dayCellDidMount: function(info) {
              const today = new Date();
              if (
                info.date.getFullYear() === today.getFullYear() &&
                info.date.getMonth() === today.getMonth() &&
                info.date.getDate() === today.getDate()
              ) {
                info.el.style.backgroundColor = "#f0f0f0";
              }
            }
          });
          calendar.render();
          window.calendarInitialized = true;
        } else {
          calendar.removeAllEvents();
          calendar.setOption('events', getCalendarUrl());
          calendar.refetchEvents();
        }
      }
    }

    function getCalendarUrl() {
      return showSentCheckbox && showSentCheckbox.checked
        ? "{% url 'task_sent_events' %}"
        : "{% url 'task_events' %}";
    }

    if (showSentCheckbox) {
      showSentCheckbox.addEventListener('change', () => {
        if (window.calendarInitialized && calendar) {
          calendar.removeAllEvents();
          calendar.setOption('events', getCalendarUrl());
          calendar.refetchEvents();
        }
      });
    }

    buttons.forEach(btn =>
      btn.addEventListener('click', () => showTab(btn.dataset.tab))
    );

    showTab('inbox');
  });
</script>
</div>
{% endblock %}
